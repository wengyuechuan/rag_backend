# RAG Backend - æ™ºèƒ½çŸ¥è¯†åº“é—®ç­”ç³»ç»Ÿ

åŸºäº **FastAPI + FAISS + Ollama + Neo4j + OpenAI** çš„å®Œæ•´ RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰åç«¯ç³»ç»Ÿã€‚

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

### ğŸ¯ æ™ºèƒ½å¯¹è¯é—®ç­” â­ NEW
- **ä¼šè¯ç®¡ç†**ï¼šå¤šä¼šè¯æ”¯æŒï¼Œè‡ªåŠ¨ç»´æŠ¤ä¸Šä¸‹æ–‡
- **RAG æ£€ç´¢**ï¼šå‘é‡æœç´¢ + çŸ¥è¯†å›¾è°±æ··åˆæ£€ç´¢
- **æ»‘åŠ¨çª—å£**ï¼šè‡ªåŠ¨å¬å›å‰5æ¡å†å²æ¶ˆæ¯
- **SSE æµå¼å“åº”**ï¼šå®æ—¶ç”Ÿæˆï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- **OpenAI é›†æˆ**ï¼šGPT-4/3.5 æ™ºèƒ½é—®ç­”

### ğŸ“š çŸ¥è¯†åº“ç®¡ç†
- **å¤šçŸ¥è¯†åº“**ï¼šæ”¯æŒåˆ›å»ºå’Œç®¡ç†å¤šä¸ªç‹¬ç«‹çŸ¥è¯†åº“
- **æ–‡æ¡£ç®¡ç†**ï¼šæ‰¹é‡ä¸Šä¼ ã€è‡ªåŠ¨å¤„ç†ã€çŠ¶æ€è·Ÿè¸ª
- **æ™ºèƒ½åˆ†å—**ï¼šè¯­ä¹‰åˆ†å—ã€å›ºå®šåˆ†å—ã€é€’å½’åˆ†å—ã€æ®µè½åˆ†å—
- **å…ƒæ•°æ®ç®¡ç†**ï¼šæ ‡ç­¾ã€åˆ†ç±»ã€è‡ªå®šä¹‰å±æ€§

### ğŸ” æ™ºèƒ½æ£€ç´¢
- **å‘é‡æœç´¢**ï¼šåŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦çš„æ–‡æ¡£æ£€ç´¢
- **å›¾è°±æœç´¢**ï¼šåŸºäºå®ä½“å…³ç³»çš„çŸ¥è¯†æ¨ç†
- **æ··åˆæœç´¢**ï¼šç»“åˆå‘é‡å’Œå›¾è°±çš„ä¼˜åŠ¿
- **é«˜æ€§èƒ½**ï¼šFAISS åŠ é€Ÿï¼Œæ”¯æŒå¤§è§„æ¨¡æ•°æ®
- **è‡ªåŠ¨æŒä¹…åŒ–**ï¼šFAISS ç´¢å¼•è‡ªåŠ¨ä¿å­˜ï¼Œé‡å¯ä¸ä¸¢å¤± â­ NEW

### ğŸ§  çŸ¥è¯†å›¾è°±
- **å®ä½“è¯†åˆ«**ï¼šè‡ªåŠ¨æå–äººç‰©ã€ç»„ç»‡ã€åœ°ç‚¹ç­‰å®ä½“
- **å…³ç³»æŠ½å–**ï¼šè¯†åˆ«å®ä½“é—´çš„è¯­ä¹‰å…³ç³»
- **å›¾è°±å­˜å‚¨**ï¼šNeo4j å›¾æ•°æ®åº“
- **å›¾è°±æ¨ç†**ï¼šè·¯å¾„æŸ¥æ‰¾ã€é‚»å±…å‘ç°ã€å­å›¾æå–

### ğŸ¤– AI å·¥ä½œæµé›†æˆ â­ NEW
- **Coze é›†æˆ**ï¼šè°ƒç”¨ Coze AI å·¥ä½œæµ
- **æµå¼è¾“å‡º**ï¼šå®æ—¶è¿”å›å¤„ç†ç»“æœ
- **çµæ´»é…ç½®**ï¼šæ”¯æŒè‡ªå®šä¹‰å‚æ•°å’Œå·¥ä½œæµ
- **æ— ç¼é›†æˆ**ï¼šä¸ RAG ç³»ç»Ÿå®Œç¾ç»“åˆ

### ğŸ”„ å¼‚æ­¥å¤„ç†
- **åå°ä»»åŠ¡**ï¼šæ–‡æ¡£å¤„ç†ä¸é˜»å¡ API å“åº”
- **çŠ¶æ€è·Ÿè¸ª**ï¼šå®æ—¶æŸ¥è¯¢å¤„ç†è¿›åº¦
- **çº¿ç¨‹æ± **ï¼šé«˜æ•ˆå¹¶å‘å¤„ç†

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

#### ğŸš€ æ–¹å¼ 1ï¼šä½¿ç”¨ uvï¼ˆæ¨èï¼Œæé€Ÿå®‰è£…ï¼‰â­ NEW

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/your-repo/RAG_backend.git
cd RAG_backend

# å®‰è£… uvï¼ˆå¦‚æœå°šæœªå®‰è£…ï¼‰
# Windows (PowerShell)
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
# macOS / Linux
curl -LsSf https://astral.sh/uv/install.sh | sh

# å¿«é€Ÿè®¾ç½®ï¼ˆè‡ªåŠ¨åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…ä¾èµ–ï¼‰
# Linux / macOS
chmod +x setup_uv.sh
./setup_uv.sh

# Windows (PowerShell)
.\setup_uv.ps1

# æˆ–æ‰‹åŠ¨è®¾ç½®
uv venv --python 3.10          # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate      # æ¿€æ´»ï¼ˆLinux/macOSï¼‰
.venv\Scripts\activate         # æ¿€æ´»ï¼ˆWindowsï¼‰
uv pip install -e .            # å®‰è£…ä¾èµ–
```

#### ğŸ“¦ æ–¹å¼ 2ï¼šä½¿ç”¨ pipï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/your-repo/RAG_backend.git
cd RAG_backend

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate       # Linux/macOS
venv\Scripts\activate          # Windows

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

**ä¸ºä»€ä¹ˆæ¨è uvï¼Ÿ**
- âš¡ æ¯” pip å¿« 10-100 å€
- ğŸ”’ æ›´å¥½çš„ä¾èµ–è§£æ
- ğŸ“¦ ç»Ÿä¸€ç®¡ç†è™šæ‹Ÿç¯å¢ƒå’ŒåŒ…
- è¯¦è§ [UV_GUIDE.md](UV_GUIDE.md)

### 2. é…ç½®ç¯å¢ƒ

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
# OpenAI é…ç½®ï¼ˆå¿…éœ€ï¼‰
OPENAI_API_KEY=sk-xxxxxxxxxxxxx
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4

# Ollama é…ç½®ï¼ˆå‘é‡æœç´¢ï¼‰
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_EMBEDDING_MODEL=nomic-embed-text

# Neo4j é…ç½®ï¼ˆå›¾è°±æœç´¢ï¼Œå¯é€‰ï¼‰
NEO4J_URI=bolt://localhost:7687
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=your_password

# Coze é…ç½®ï¼ˆAI å·¥ä½œæµï¼Œå¯é€‰ï¼‰â­ NEW
COZE_API_KEY=pat_xxxxxxxxxxxxx
COZE_WORKFLOW_ID=7562785533798547507
```

### 3. å¯åŠ¨æœåŠ¡

#### å¯åŠ¨ Ollamaï¼ˆå‘é‡æœç´¢ï¼‰
```bash
# å®‰è£… Ollama: https://ollama.ai
ollama serve

# æ‹‰å–åµŒå…¥æ¨¡å‹
ollama pull nomic-embed-text
```

#### å¯åŠ¨ Neo4jï¼ˆå¯é€‰ï¼Œå›¾è°±æœç´¢ï¼‰
```bash
docker run \
    --name neo4j \
    -p 7474:7474 -p 7687:7687 \
    -e NEO4J_AUTH=neo4j/password \
    neo4j:latest
```

#### å¯åŠ¨ API æœåŠ¡å™¨
```bash
python main.py
```

è®¿é—® **API æ–‡æ¡£**: http://localhost:8000/docs

### 4. å¿«é€Ÿæµ‹è¯•

#### æ–¹å¼ 1ï¼šä½¿ç”¨å‘½ä»¤è¡Œå®¢æˆ·ç«¯ï¼ˆæ¨èï¼‰

```bash
# äº¤äº’å¼å¯¹è¯
python chat_client.py
```

#### æ–¹å¼ 2ï¼šä½¿ç”¨æµ‹è¯•è„šæœ¬

```bash
# è‡ªåŠ¨åŒ–æµ‹è¯•
python test_chat.py
```

#### æ–¹å¼ 3ï¼šä½¿ç”¨ API

```bash
# 1. åˆ›å»ºçŸ¥è¯†åº“
curl -X POST "http://localhost:8000/api/v1/knowledge-bases" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "AIçŸ¥è¯†åº“",
    "description": "äººå·¥æ™ºèƒ½ç›¸å…³æ–‡æ¡£",
    "enable_vector_store": true,
    "enable_ner": true,
    "enable_knowledge_graph": true
  }'

# 2. ä¸Šä¼ æ–‡æ¡£
curl -X POST "http://localhost:8000/api/v1/documents" \
  -H "Content-Type: application/json" \
  -d '{
    "knowledge_base_id": 1,
    "title": "AIç®€ä»‹",
    "content": "äººå·¥æ™ºèƒ½æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œè‡´åŠ›äºåˆ›å»ºèƒ½å¤Ÿæ‰§è¡Œé€šå¸¸éœ€è¦äººç±»æ™ºèƒ½çš„ä»»åŠ¡çš„ç³»ç»Ÿ...",
    "auto_process": true
  }'

# 3. åˆ›å»ºå¯¹è¯ä¼šè¯
curl -X POST "http://localhost:8000/api/v1/chat/sessions" \
  -H "Content-Type: application/json" \
  -d '{
    "knowledge_base_id": 1,
    "title": "AIå­¦ä¹ å¯¹è¯",
    "use_vector_search": true,
    "use_graph_search": true
  }'

# 4. å¼€å§‹å¯¹è¯ï¼ˆæµå¼ï¼‰
curl -N -X POST "http://localhost:8000/api/v1/chat/completions" \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": 1,
    "message": "ä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ï¼Ÿ",
    "stream": true
  }'
```

## ğŸ“– å®Œæ•´åŠŸèƒ½æ¼”ç¤º

### 1. çŸ¥è¯†åº“ç®¡ç†

```python
import requests

BASE_URL = "http://localhost:8000/api/v1"

# åˆ›å»ºçŸ¥è¯†åº“
kb_response = requests.post(
    f"{BASE_URL}/knowledge-bases",
    json={
        "name": "æŠ€æœ¯æ–‡æ¡£åº“",
        "description": "è½¯ä»¶å¼€å‘ç›¸å…³æ–‡æ¡£",
        "enable_vector_store": True,
        "enable_ner": True,
        "enable_knowledge_graph": True
    }
)
kb = kb_response.json()
print(f"çŸ¥è¯†åº“ ID: {kb['id']}")
```

### 2. æ–‡æ¡£ä¸Šä¼ å’Œå¤„ç†

```python
# ä¸Šä¼ æ–‡æ¡£
doc_response = requests.post(
    f"{BASE_URL}/documents",
    json={
        "knowledge_base_id": kb['id'],
        "title": "Python æ•™ç¨‹",
        "content": "Python æ˜¯ä¸€ç§é«˜çº§ç¼–ç¨‹è¯­è¨€...",
        "auto_process": True  # è‡ªåŠ¨å¤„ç†ï¼šåˆ†å— + å‘é‡åŒ– + NER
    }
)
doc = doc_response.json()

# æŸ¥è¯¢å¤„ç†çŠ¶æ€
status = requests.get(f"{BASE_URL}/documents/{doc['id']}/status")
print(status.json())
```

### 3. Coze å·¥ä½œæµè°ƒç”¨ â­ NEW

```python
# è°ƒç”¨ Coze å·¥ä½œæµ
response = requests.post(
    f"{BASE_URL}/coze/workflow/run",
    json={
        "workflow_id": "7562785533798547507",
        "input_text": "åŒ—äº¬ä»Šå¤©åº”è¯¥ç©¿ä»€ä¹ˆè¡£æœ"
    }
)
result = response.json()
print(f"è¾“å‡º: {result['output']}")
print(f"Token: {result['total_tokens']}")

# æˆ–ä½¿ç”¨ç®€åŒ–æ¥å£ï¼ˆä½¿ç”¨é»˜è®¤å·¥ä½œæµï¼‰
response = requests.post(
    f"{BASE_URL}/coze/simple",
    json={"input_text": "ä¸Šæµ·ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·"}
)
print(response.json()['output'])
```

### 4. æ™ºèƒ½å¯¹è¯

```python
# åˆ›å»ºä¼šè¯
session = requests.post(
    f"{BASE_URL}/chat/sessions",
    json={
        "knowledge_base_id": kb['id'],
        "use_vector_search": True,
        "use_graph_search": True
    }
).json()

# æµå¼å¯¹è¯
import json

response = requests.post(
    f"{BASE_URL}/chat/completions",
    json={
        "session_id": session['id'],
        "message": "Python æœ‰å“ªäº›ç‰¹ç‚¹ï¼Ÿ",
        "stream": True
    },
    stream=True
)

print("AI: ", end='', flush=True)
for line in response.iter_lines():
    if line and line.startswith(b'data: '):
        data = json.loads(line[6:])
        if data['type'] == 'chunk':
            print(data['data'], end='', flush=True)
print()
```

### 5. æ··åˆæœç´¢

```python
# å‘é‡æœç´¢ + å›¾è°±æœç´¢
search_response = requests.post(
    f"{BASE_URL}/search",
    json={
        "query": "Python çš„åˆ›å§‹äººæ˜¯è°",
        "knowledge_base_id": kb['id'],
        "top_k": 5,
        "use_vector": True,
        "use_graph": True
    }
)

result = search_response.json()

# æŸ¥çœ‹æ–‡æœ¬å—ç»“æœ
for r in result['results']:
    print(f"æ–‡æ¡£: {r['document_title']}")
    print(f"å†…å®¹: {r['content'][:100]}...")
    print(f"è¯„åˆ†: {r['score']:.3f}")
    if r['entities']:
        print(f"å®ä½“: {', '.join(r['entities'])}")
    print()

# æŸ¥çœ‹å›¾è°±ç»“æœ
if result['graph_results']:
    for gr in result['graph_results']:
        print(f"å®ä½“: {gr['entity_name']} ({gr['entity_type']})")
        print(f"ç›¸å…³å®ä½“:")
        for rel in gr['related_entities']:
            print(f"  - {rel['name']} ({rel['relation']})")
```

## ğŸ“Š ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·/å®¢æˆ·ç«¯                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FastAPI REST API                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â­NEWâ”‚
â”‚  â”‚çŸ¥è¯†åº“ç®¡ç†â”‚ â”‚ æ–‡æ¡£ç®¡ç† â”‚ â”‚  æœç´¢  â”‚ â”‚  å¯¹è¯  â”‚ â”‚Cozeâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚               â”‚               â”‚
         â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    SQLite    â”‚ â”‚  æ–‡æ¡£å¤„ç†æœåŠ¡  â”‚ â”‚  å¯¹è¯æœåŠ¡    â”‚
â”‚   æ•°æ®åº“     â”‚ â”‚ (å¼‚æ­¥åå°)    â”‚ â”‚ (SSEæµå¼)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚               â”‚
         â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æ–‡æ¡£åˆ†å— (TextChunker)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ è¯­ä¹‰ â”‚ â”‚ å›ºå®š â”‚ â”‚ é€’å½’ â”‚ â”‚ æ®µè½ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
     â”‚               â”‚
     â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘é‡åŒ–   â”‚   â”‚  å®ä½“å…³ç³»æå– â”‚
â”‚ Ollama   â”‚   â”‚  OpenAI GPT  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚
     â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FAISS   â”‚   â”‚    Neo4j     â”‚
â”‚ å‘é‡å­˜å‚¨  â”‚   â”‚  çŸ¥è¯†å›¾è°±    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   RAG æ£€ç´¢     â”‚
     â”‚ å‘é‡ + å›¾è°±    â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ OpenAI GPT-4   â”‚
     â”‚  æ™ºèƒ½å›ç­”      â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ æ ¸å¿ƒç»„ä»¶

### 1. æ–‡æ¡£åˆ†å— (`utils/chunk.py`)

æ”¯æŒå¤šç§åˆ†å—ç­–ç•¥ï¼š

```python
from utils.chunk import TextChunker

chunker = TextChunker(chunk_size=500, chunk_overlap=100)

# è¯­ä¹‰åˆ†å—ï¼ˆæ¨èï¼‰
chunks = chunker.semantic_chunking(text, language='zh')

# å›ºå®šå¤§å°åˆ†å—
chunks = chunker.fixed_size_chunking(text)

# é€’å½’åˆ†å—
chunks = chunker.recursive_chunking(text)

# æ®µè½åˆ†å—
chunks = chunker.paragraph_chunking(text)
```

### 2. å‘é‡å­˜å‚¨ (`utils/faiss.py`)

åŸºäº FAISS çš„é«˜æ€§èƒ½å‘é‡æ£€ç´¢ï¼š

```python
from utils.faiss import FaissVectorStore

# åˆå§‹åŒ–
store = FaissVectorStore(
    embedding_model="nomic-embed-text",
    index_type="Flat",  # Flat/IVF/HNSW
    metric="Cosine"     # L2/IP/Cosine
)

# æ·»åŠ æ–‡æ¡£
store.add_texts(texts, metadatas)

# æœç´¢
results = store.search("æŸ¥è¯¢", top_k=5)

# ä¿å­˜/åŠ è½½
store.save("./index")
loaded = FaissVectorStore.load("./index")
```

### 3. çŸ¥è¯†å›¾è°± (`utils/neo4j.py`)

åŸºäº Neo4j çš„å›¾è°±å­˜å‚¨å’ŒæŸ¥è¯¢ï¼š

```python
from utils.neo4j import Neo4jKnowledgeGraph

kg = Neo4jKnowledgeGraph(
    uri="bolt://localhost:7687",
    username="neo4j",
    password="password"
)

# æ’å…¥ä¸‰å…ƒç»„
kg.insert_triple("å¼ ä¸‰", "Person", "WORKS_AT", "å…¬å¸A", "Company")

# æŸ¥è¯¢å…³ç³»
relations = kg.find_relations(subject="å¼ ä¸‰")

# æŸ¥æ‰¾é‚»å±…
neighbors = kg.get_neighbors("å¼ ä¸‰", direction="out")

# æŸ¥æ‰¾è·¯å¾„
paths = kg.get_path("å¼ ä¸‰", "Python", max_depth=3)
```

### 4. å®ä½“å…³ç³»æå– (`utils/chunk_to_ner.py`)

åŸºäº OpenAI çš„æ™ºèƒ½ NERï¼š

```python
from utils.chunk_to_ner import EntityRelationExtractor

extractor = EntityRelationExtractor(
    model="gpt-4",
    temperature=0.3
)

# æå–å®ä½“å’Œå…³ç³»
result = extractor.process_text(text, use_workflow=True)

# å®ä½“
for entity in result['entities']:
    print(f"{entity.name} ({entity.entity_type})")

# å…³ç³»
for relation in result['relations']:
    print(f"{relation.subject} --[{relation.predicate}]--> {relation.object}")
```

### 5. æ–‡æ¡£å¤„ç†æœåŠ¡ (`api/services/document_service.py`)

å¼‚æ­¥æ–‡æ¡£å¤„ç†ï¼š

```python
from api.services.document_service import document_service

# å¼‚æ­¥å¤„ç†æ–‡æ¡£
document_service.process_document_async(document_id, kb_id)

# æŸ¥è¯¢å¤„ç†çŠ¶æ€
status = document_service.get_processing_status(document_id)
```

## ğŸ“š API ç«¯ç‚¹æ€»è§ˆ

### çŸ¥è¯†åº“ç®¡ç†
- `POST /api/v1/knowledge-bases` - åˆ›å»ºçŸ¥è¯†åº“
- `GET /api/v1/knowledge-bases` - è·å–çŸ¥è¯†åº“åˆ—è¡¨
- `GET /api/v1/knowledge-bases/{id}` - è·å–çŸ¥è¯†åº“è¯¦æƒ…
- `PATCH /api/v1/knowledge-bases/{id}` - æ›´æ–°çŸ¥è¯†åº“
- `DELETE /api/v1/knowledge-bases/{id}` - åˆ é™¤çŸ¥è¯†åº“

### æ–‡æ¡£ç®¡ç†
- `POST /api/v1/documents` - åˆ›å»ºæ–‡æ¡£
- `POST /api/v1/documents/upload` - ä¸Šä¼ æ–‡ä»¶
- `GET /api/v1/documents` - è·å–æ–‡æ¡£åˆ—è¡¨
- `GET /api/v1/documents/{id}` - è·å–æ–‡æ¡£è¯¦æƒ…
- `PATCH /api/v1/documents/{id}` - æ›´æ–°æ–‡æ¡£
- `DELETE /api/v1/documents/{id}` - åˆ é™¤æ–‡æ¡£
- `POST /api/v1/documents/{id}/process` - æ‰‹åŠ¨å¤„ç†æ–‡æ¡£
- `GET /api/v1/documents/{id}/status` - æŸ¥è¯¢å¤„ç†çŠ¶æ€
- `GET /api/v1/documents/{id}/chunks` - è·å–æ–‡æ¡£åˆ†å—

### æœç´¢
- `POST /api/v1/search` - æ··åˆæœç´¢ï¼ˆå‘é‡ + å›¾è°±ï¼‰

### å¯¹è¯ç®¡ç† â­ NEW
- `POST /api/v1/chat/sessions` - åˆ›å»ºä¼šè¯
- `GET /api/v1/chat/sessions` - è·å–ä¼šè¯åˆ—è¡¨
- `GET /api/v1/chat/sessions/{id}` - è·å–ä¼šè¯è¯¦æƒ…
- `PATCH /api/v1/chat/sessions/{id}` - æ›´æ–°ä¼šè¯
- `DELETE /api/v1/chat/sessions/{id}` - åˆ é™¤ä¼šè¯
- `GET /api/v1/chat/sessions/{id}/history` - è·å–ä¼šè¯å†å²
- `POST /api/v1/chat/completions` - å‘é€æ¶ˆæ¯ï¼ˆæ”¯æŒ SSE æµå¼ï¼‰

å®Œæ•´ API æ–‡æ¡£ï¼šhttp://localhost:8000/docs

## ğŸ”§ é…ç½®è¯´æ˜

### çŸ¥è¯†åº“é…ç½®

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `enable_vector_store` | æ˜¯å¦å¯ç”¨å‘é‡æœç´¢ | true |
| `enable_ner` | æ˜¯å¦å¯ç”¨å®ä½“è¯†åˆ« | false |
| `enable_knowledge_graph` | æ˜¯å¦å¯ç”¨çŸ¥è¯†å›¾è°± | false |
| `default_chunk_strategy` | é»˜è®¤åˆ†å—ç­–ç•¥ | semantic |
| `default_chunk_size` | é»˜è®¤åˆ†å—å¤§å° | 500 |
| `default_chunk_overlap` | é»˜è®¤é‡å å¤§å° | 100 |

### å¯¹è¯é…ç½®

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `use_vector_search` | æ˜¯å¦ä½¿ç”¨å‘é‡æœç´¢ | true |
| `use_graph_search` | æ˜¯å¦ä½¿ç”¨å›¾è°±æœç´¢ | false |
| `search_top_k` | æ£€ç´¢æ–‡æ¡£æ•°é‡ | 5 |
| `temperature` | ç”Ÿæˆæ¸©åº¦ | 0.7 |
| `max_tokens` | æœ€å¤§ç”Ÿæˆé•¿åº¦ | 2000 |

## ğŸ“ é¡¹ç›®ç»“æ„

```
RAG_backend/
â”œâ”€â”€ api/                         # FastAPI åº”ç”¨
â”‚   â”œâ”€â”€ routers/                # è·¯ç”±æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ knowledge_base.py  # çŸ¥è¯†åº“è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ document.py         # æ–‡æ¡£è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ search.py           # æœç´¢è·¯ç”±
â”‚   â”‚   â””â”€â”€ chat.py             # å¯¹è¯è·¯ç”± â­ NEW
â”‚   â”œâ”€â”€ services/               # ä¸šåŠ¡æœåŠ¡
â”‚   â”‚   â””â”€â”€ document_service.py # æ–‡æ¡£å¤„ç†æœåŠ¡
â”‚   â””â”€â”€ schemas.py              # Pydantic æ•°æ®æ¨¡å‹
â”œâ”€â”€ database/                    # æ•°æ®åº“æ¨¡å—
â”‚   â”œâ”€â”€ models.py               # SQLAlchemy æ¨¡å‹
â”‚   â”œâ”€â”€ database.py             # æ•°æ®åº“è¿æ¥
â”‚   â””â”€â”€ __init__.py
â”œâ”€â”€ utils/                       # å·¥å…·æ¨¡å—
â”‚   â”œâ”€â”€ chunk.py                # æ–‡æ¡£åˆ†å—
â”‚   â”œâ”€â”€ faiss.py                # å‘é‡å­˜å‚¨
â”‚   â”œâ”€â”€ neo4j.py                # çŸ¥è¯†å›¾è°±
â”‚   â”œâ”€â”€ chunk_to_ner.py         # å®ä½“å…³ç³»æå–
â”‚   â””â”€â”€ file_parser.py          # æ–‡ä»¶è§£æ
â”œâ”€â”€ docs/                        # æ–‡æ¡£
â”‚   â”œâ”€â”€ CHAT_API_GUIDE.md       # å¯¹è¯ API æŒ‡å— â­ NEW
â”‚   â”œâ”€â”€ CHAT_QUICKSTART.md      # å¯¹è¯å¿«é€Ÿå¼€å§‹ â­ NEW
â”‚   â”œâ”€â”€ GRAPH_SEARCH_GUIDE.md   # å›¾è°±æœç´¢æŒ‡å—
â”‚   â”œâ”€â”€ API_DOCUMENTATION.md    # API æ–‡æ¡£
â”‚   â””â”€â”€ ...
â”œâ”€â”€ main.py                      # FastAPI ä¸»åº”ç”¨
â”œâ”€â”€ test_chat.py                 # å¯¹è¯æµ‹è¯•è„šæœ¬ â­ NEW
â”œâ”€â”€ chat_client.py               # å‘½ä»¤è¡Œå®¢æˆ·ç«¯ â­ NEW
â”œâ”€â”€ pyproject.toml               # é¡¹ç›®é…ç½®ï¼ˆuv/pipï¼‰â­ NEW
â”œâ”€â”€ requirements.txt             # ä¾èµ–åˆ—è¡¨ï¼ˆå¤‡ç”¨ï¼‰
â”œâ”€â”€ setup_uv.sh                  # uv å¿«é€Ÿè®¾ç½®è„šæœ¬ï¼ˆLinux/macOSï¼‰â­ NEW
â”œâ”€â”€ setup_uv.ps1                 # uv å¿«é€Ÿè®¾ç½®è„šæœ¬ï¼ˆWindowsï¼‰â­ NEW
â”œâ”€â”€ UV_GUIDE.md                  # uv ä½¿ç”¨æŒ‡å— â­ NEW
â”œâ”€â”€ .env                         # ç¯å¢ƒå˜é‡
â”œâ”€â”€ .gitignore                   # Git å¿½ç•¥æ–‡ä»¶
â””â”€â”€ README.md                    # é¡¹ç›®è¯´æ˜
```

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç”¨é€” | ç‰ˆæœ¬ |
|------|------|------|
| **uv** | åŒ…ç®¡ç†å™¨ | latest â­ NEW |
| **FastAPI** | Web æ¡†æ¶ | >=0.104.0 |
| **SQLAlchemy** | ORM | >=2.0.0 |
| **SQLite** | æ•°æ®åº“ | - |
| **Pydantic** | æ•°æ®éªŒè¯ | >=2.0.0 |
| **FAISS** | å‘é‡æœç´¢ | >=1.7.4 |
| **Ollama** | æœ¬åœ°åµŒå…¥ | - |
| **OpenAI** | LLM æœåŠ¡ | >=1.10.0 |
| **Neo4j** | å›¾æ•°æ®åº“ | >=5.0 |
| **LangGraph** | å·¥ä½œæµ | >=0.0.30 |

## ğŸ“– è¯¦ç»†æ–‡æ¡£

- **ç¯å¢ƒé…ç½®**
  - [uv ä½¿ç”¨æŒ‡å—](UV_GUIDE.md) â­ NEW
- **API æ–‡æ¡£**
  - [å®Œæ•´ API æ–‡æ¡£](docs/API_DOCUMENTATION.md)
  - [å¯¹è¯ API æŒ‡å—](docs/CHAT_API_GUIDE.md) â­ NEW
  - [å¯¹è¯å¿«é€Ÿå¼€å§‹](docs/CHAT_QUICKSTART.md) â­ NEW
- **åŠŸèƒ½æŒ‡å—**
  - [Coze å·¥ä½œæµé›†æˆ](docs/COZE_GUIDE.md) â­ NEW
  - [Coze API æ¥å£æ–‡æ¡£](docs/COZE_API_GUIDE.md) â­ NEW
  - [FAISS æŒä¹…åŒ–è¯´æ˜](docs/FAISS_PERSISTENCE.md) â­ NEW
  - [å›¾è°±æœç´¢æŒ‡å—](docs/GRAPH_SEARCH_GUIDE.md)
  - [å®ä½“å…³ç³»æ¨¡å‹](docs/ENTITY_RELATION_MODEL.md)
  - [å¼‚æ­¥å¤„ç†è¯´æ˜](docs/ASYNC_PROCESSING.md)

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### 1. æ™ºèƒ½æ–‡æ¡£é—®ç­”
```
ç”¨æˆ·ï¼šPython æœ‰å“ªäº›ç‰¹ç‚¹ï¼Ÿ
ç³»ç»Ÿï¼š[æ£€ç´¢ç›¸å…³æ–‡æ¡£] â†’ [ç”Ÿæˆç­”æ¡ˆ]
```

### 2. çŸ¥è¯†å›¾è°±æŸ¥è¯¢
```
ç”¨æˆ·ï¼šå°æ˜çš„çˆ¶äº²æ˜¯è°ï¼Ÿ
ç³»ç»Ÿï¼š[å›¾è°±æŸ¥è¯¢] â†’ æ‰¾åˆ°å…³ç³» â†’ å¼ ä¸‰
```

### 3. æ··åˆæ£€ç´¢
```
ç”¨æˆ·ï¼šæ·±åº¦å­¦ä¹ çš„åº”ç”¨é¢†åŸŸ
ç³»ç»Ÿï¼š[å‘é‡æœç´¢] + [å›¾è°±æ¨ç†] â†’ ç»¼åˆç­”æ¡ˆ
```

### 4. ä¼ä¸šçŸ¥è¯†åº“
- æŠ€æœ¯æ–‡æ¡£åº“
- äº§å“æ‰‹å†Œåº“
- å®¢æœçŸ¥è¯†åº“
- æ³•å¾‹æ³•è§„åº“

### 5. AI å·¥ä½œæµå¢å¼º â­ NEW
```python
from utils.coze import run_coze_workflow

# è°ƒç”¨ Coze å·¥ä½œæµ
result = run_coze_workflow(
    workflow_id="7562785533798547507",
    input_text="åŒ—äº¬ä»Šå¤©åº”è¯¥ç©¿ä»€ä¹ˆè¡£æœ"
)
print(result)
# è¾“å‡º: ä»Šå¤©åŒ—äº¬å¤©æ°”æ™´æœ—ï¼Œä½†æ°”æ¸©è¾ƒä½ä¸”æœ‰é£ï¼Œ
#       å»ºè®®ç©¿ç€åšå¤–å¥—ã€æ¯›è¡£ã€ä¿æš–è£¤...
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### ç´¢å¼•é€‰æ‹©
- **å°æ•°æ®é›† (<10K)**: ä½¿ç”¨ `Flat` ç´¢å¼•
- **ä¸­ç­‰æ•°æ®é›† (10K-1M)**: ä½¿ç”¨ `HNSW` ç´¢å¼•
- **å¤§æ•°æ®é›† (>1M)**: ä½¿ç”¨ `IVF` ç´¢å¼•

### åˆ†å—ç­–ç•¥
- **RAG é—®ç­”**: è¯­ä¹‰åˆ†å— (200-500 å­—ç¬¦)
- **é•¿æ–‡æ¡£æ£€ç´¢**: é€’å½’åˆ†å— (500-1000 å­—ç¬¦)
- **ç»“æ„åŒ–æ–‡æ¡£**: æ®µè½åˆ†å—

### GPU åŠ é€Ÿ
```bash
# ä½¿ç”¨ GPU ç‰ˆæœ¬çš„ FAISS
pip install faiss-gpu
```

## ğŸ› å¸¸è§é—®é¢˜

### Q: Ollama è¿æ¥å¤±è´¥ï¼Ÿ
```bash
# æ£€æŸ¥ Ollama æœåŠ¡
curl http://localhost:11434/api/tags

# é‡å¯ Ollama
ollama serve
```

### Q: OpenAI API è°ƒç”¨å¤±è´¥ï¼Ÿ
```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
curl http://localhost:8000/config

# ç¡®è®¤ API Key æ˜¯å¦æ­£ç¡®
echo $OPENAI_API_KEY
```

### Q: Neo4j è¿æ¥å¤±è´¥ï¼Ÿ
```bash
# æ£€æŸ¥ Neo4j å®¹å™¨
docker ps | grep neo4j

# æŸ¥çœ‹æ—¥å¿—
docker logs neo4j

# æµ‹è¯•è¿æ¥
curl http://localhost:7474
```

### Q: æ–‡æ¡£å¤„ç†å¤±è´¥ï¼Ÿ
1. æ£€æŸ¥çŸ¥è¯†åº“é…ç½®æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤å¿…è¦çš„æœåŠ¡å·²å¯åŠ¨ï¼ˆOllama/Neo4jï¼‰
3. æŸ¥çœ‹æ–‡æ¡£å¤„ç†çŠ¶æ€ï¼š`GET /api/v1/documents/{id}/status`

## ğŸš€ éƒ¨ç½²å»ºè®®

### å¼€å‘ç¯å¢ƒ
```bash
python main.py
```

### ç”Ÿäº§ç¯å¢ƒ
```bash
# ä½¿ç”¨ Gunicorn + Uvicorn
pip install gunicorn

gunicorn main:app \
  --workers 4 \
  --worker-class uvicorn.workers.UvicornWorker \
  --bind 0.0.0.0:8000
```

### Docker éƒ¨ç½²
```dockerfile
FROM python:3.10-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

## ğŸ“ˆ è·¯çº¿å›¾

- [x] æ–‡æ¡£åˆ†å—å’Œå‘é‡å­˜å‚¨
- [x] FAISS å‘é‡æ£€ç´¢
- [x] Neo4j çŸ¥è¯†å›¾è°±
- [x] å®ä½“å…³ç³»æå–
- [x] REST API
- [x] å¼‚æ­¥æ–‡æ¡£å¤„ç†
- [x] æ™ºèƒ½å¯¹è¯é—®ç­”
- [x] SSE æµå¼å“åº”
- [ ] ç”¨æˆ·è®¤è¯å’Œæƒé™ç®¡ç†
- [ ] å¤šæ¨¡æ€æ”¯æŒï¼ˆå›¾ç‰‡ã€éŸ³é¢‘ï¼‰
- [ ] åˆ†å¸ƒå¼éƒ¨ç½²
- [ ] æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

1. Fork æœ¬é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ï¼š`git checkout -b feature/AmazingFeature`
3. æäº¤æ›´æ”¹ï¼š`git commit -m 'Add some AmazingFeature'`
4. æ¨é€åˆ°åˆ†æ”¯ï¼š`git push origin feature/AmazingFeature`
5. æäº¤ Pull Request

## ğŸ“® è”ç³»æ–¹å¼

- é¡¹ç›®åœ°å€ï¼š[GitHub](https://github.com/your-repo/RAG_backend)
- é—®é¢˜åé¦ˆï¼š[Issues](https://github.com/your-repo/RAG_backend/issues)

## ğŸ™ è‡´è°¢

- [FastAPI](https://fastapi.tiangolo.com/)
- [FAISS](https://github.com/facebookresearch/faiss)
- [Ollama](https://ollama.ai/)
- [Neo4j](https://neo4j.com/)
- [OpenAI](https://openai.com/)
- [LangGraph](https://github.com/langchain-ai/langgraph)

---

**â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸€ä¸ª Starï¼**
