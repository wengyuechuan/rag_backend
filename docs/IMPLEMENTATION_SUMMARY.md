# å¯¹è¯æ¥å£å®ç°æ€»ç»“

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. æ•°æ®åº“æ¨¡å‹è®¾è®¡

#### æ–°å¢æ¨¡å‹
- **`MessageRoleEnum`**: æ¶ˆæ¯è§’è‰²æšä¸¾ï¼ˆuser/assistant/systemï¼‰
- **`ChatSession`**: ä¼šè¯æ¨¡å‹
  - å…³è”çŸ¥è¯†åº“
  - é…ç½®æœç´¢å‚æ•°ï¼ˆå‘é‡æœç´¢ã€å›¾è°±æœç´¢ã€Top-Kï¼‰
  - ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ¶ˆæ¯æ•°ã€Token æ•°ï¼‰
  - æ—¶é—´æˆ³ï¼ˆåˆ›å»ºã€æ›´æ–°ã€æœ€åæ´»è·ƒï¼‰
  
- **`ChatMessage`**: æ¶ˆæ¯æ¨¡å‹
  - è§’è‰²å’Œå†…å®¹
  - RAG ä¿¡æ¯ï¼ˆæ£€ç´¢çš„æ–‡æœ¬å—ã€å®ä½“ã€ä¸Šä¸‹æ–‡ï¼‰
  - ç»Ÿè®¡ä¿¡æ¯ï¼ˆToken æ•°ã€å¤„ç†æ—¶é—´ï¼‰

### 2. API Schemas

#### æ–°å¢ Pydantic æ¨¡å‹
- `ChatSessionCreate`: åˆ›å»ºä¼šè¯è¯·æ±‚
- `ChatSessionUpdate`: æ›´æ–°ä¼šè¯è¯·æ±‚
- `ChatSessionResponse`: ä¼šè¯å“åº”
- `ChatMessageResponse`: æ¶ˆæ¯å“åº”
- `ChatRequest`: å¯¹è¯è¯·æ±‚
- `ChatHistoryResponse`: ä¼šè¯å†å²å“åº”

### 3. API è·¯ç”±å®ç°

#### `/api/v1/chat/sessions` - ä¼šè¯ç®¡ç†
- `POST /sessions` - åˆ›å»ºä¼šè¯
- `GET /sessions` - è·å–ä¼šè¯åˆ—è¡¨
- `GET /sessions/{id}` - è·å–ä¼šè¯è¯¦æƒ…
- `PATCH /sessions/{id}` - æ›´æ–°ä¼šè¯é…ç½®
- `DELETE /sessions/{id}` - åˆ é™¤ä¼šè¯
- `GET /sessions/{id}/history` - è·å–ä¼šè¯å†å²

#### `/api/v1/chat/completions` - å¯¹è¯æ¥å£
- `POST /completions` - å‘é€æ¶ˆæ¯
  - æ”¯æŒ**æµå¼å“åº”ï¼ˆSSEï¼‰**
  - æ”¯æŒéæµå¼å“åº”
  - é›†æˆ RAG æ£€ç´¢ï¼ˆå‘é‡ + å›¾è°±ï¼‰
  - è‡ªåŠ¨ç»´æŠ¤ä¸Šä¸‹æ–‡ï¼ˆæ»‘åŠ¨çª—å£ï¼‰

### 4. æ ¸å¿ƒåŠŸèƒ½å®ç°

#### RAG æ£€ç´¢å¢å¼º
```python
# å‘é‡æœç´¢
chunks_with_scores = document_service.search_documents(...)

# å›¾è°±æœç´¢
graph_results = document_service.search_graph(...)
```

#### æ»‘åŠ¨çª—å£ä¸Šä¸‹æ–‡
- è‡ªåŠ¨å¬å›**å‰5æ¡å†å²æ¶ˆæ¯**
- ä¿æŒå¯¹è¯è¿è´¯æ€§
- æ§åˆ¶ Token æ¶ˆè€—

#### SSE æµå¼å“åº”
```
data: {"type": "context", "data": {...}}
data: {"type": "chunk", "data": "æ–‡æœ¬ç‰‡æ®µ"}
data: {"type": "done", "data": {...}}
```

#### OpenAI é›†æˆ
- ä½¿ç”¨ OpenAI SDK
- æ”¯æŒè‡ªå®šä¹‰ base_urlï¼ˆå…¼å®¹å…¶ä»– APIï¼‰
- å¯é…ç½®æ¨¡å‹ã€æ¸©åº¦ã€æœ€å¤§é•¿åº¦

### 5. æ–‡æ¡£å’Œå·¥å…·

#### æ–‡æ¡£
- `docs/CHAT_API_GUIDE.md` - å®Œæ•´ API ä½¿ç”¨æŒ‡å—
- `docs/CHAT_QUICKSTART.md` - å¿«é€Ÿå¯åŠ¨æŒ‡å—
- `IMPLEMENTATION_SUMMARY.md` - å®ç°æ€»ç»“ï¼ˆæœ¬æ–‡ä»¶ï¼‰

#### æµ‹è¯•å’Œå®¢æˆ·ç«¯
- `test_chat.py` - è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
- `chat_client.py` - å‘½ä»¤è¡Œäº¤äº’å¼èŠå¤©å®¢æˆ·ç«¯

## ğŸ“Š æŠ€æœ¯æ ˆ

- **Web æ¡†æ¶**: FastAPI
- **æ•°æ®åº“**: SQLite + SQLAlchemy ORM
- **AI SDK**: OpenAI (å®˜æ–¹ Python SDK)
- **æµå¼é€šä¿¡**: SSE (Server-Sent Events)
- **RAG æ£€ç´¢**: 
  - å‘é‡æœç´¢ï¼šFAISS + Ollama Embeddings
  - å›¾è°±æœç´¢ï¼šåŸºäºå®ä½“å…³ç³»çš„åŒ¹é…
- **å¹¶å‘å¤„ç†**: ThreadPoolExecutor

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â†“
1. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°æ•°æ®åº“
    â†“
2. RAG æ£€ç´¢
    â”œâ”€ å‘é‡æœç´¢ï¼šè¯­ä¹‰ç›¸ä¼¼çš„æ–‡æ¡£å—
    â””â”€ å›¾è°±æœç´¢ï¼šç›¸å…³å®ä½“å’Œå…³ç³»
    â†“
3. æ„å»ºä¸Šä¸‹æ–‡
    â”œâ”€ æ£€ç´¢åˆ°çš„æ–‡æ¡£å†…å®¹
    â”œâ”€ å®ä½“å…³ç³»ä¿¡æ¯
    â””â”€ å†å²æ¶ˆæ¯ï¼ˆæœ€è¿‘5æ¡ï¼‰
    â†“
4. æ„å»º Prompt
    â”œâ”€ System: çŸ¥è¯†åº“ä¿¡æ¯ + æ£€ç´¢å†…å®¹
    â”œâ”€ History: æœ€è¿‘5æ¡å¯¹è¯
    â””â”€ User: å½“å‰é—®é¢˜
    â†“
5. è°ƒç”¨ OpenAI API
    â”œâ”€ æµå¼æ¨¡å¼ï¼šå®æ—¶è¿”å›
    â””â”€ éæµå¼æ¨¡å¼ï¼šä¸€æ¬¡æ€§è¿”å›
    â†“
6. ä¿å­˜åŠ©æ‰‹å›å¤åˆ°æ•°æ®åº“
    â”œâ”€ å†…å®¹
    â”œâ”€ æ£€ç´¢ä¿¡æ¯
    â”œâ”€ ç»Ÿè®¡æ•°æ®
    â””â”€ æ›´æ–°ä¼šè¯ç»Ÿè®¡
    â†“
è¿”å›ç»™ç”¨æˆ·
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
RAG_backend/
â”œâ”€â”€ database/
â”‚   â””â”€â”€ models.py                 # âœ… æ–°å¢ä¼šè¯å’Œæ¶ˆæ¯æ¨¡å‹
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ schemas.py                # âœ… æ–°å¢å¯¹è¯ç›¸å…³ schemas
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â””â”€â”€ chat.py               # âœ… æ–°å¢å¯¹è¯è·¯ç”±
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ document_service.py   # å·²æœ‰ï¼ˆsearch_graph æ–¹æ³•ï¼‰
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ CHAT_API_GUIDE.md         # âœ… å®Œæ•´ API æ–‡æ¡£
â”‚   â”œâ”€â”€ CHAT_QUICKSTART.md        # âœ… å¿«é€Ÿå¯åŠ¨æŒ‡å—
â”‚   â””â”€â”€ GRAPH_SEARCH_GUIDE.md     # å·²æœ‰
â”œâ”€â”€ main.py                        # âœ… æ³¨å†Œ chat è·¯ç”±
â”œâ”€â”€ test_chat.py                   # âœ… æµ‹è¯•è„šæœ¬
â”œâ”€â”€ chat_client.py                 # âœ… å‘½ä»¤è¡Œå®¢æˆ·ç«¯
â””â”€â”€ IMPLEMENTATION_SUMMARY.md      # âœ… å®ç°æ€»ç»“
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é…ç½®ç¯å¢ƒ

```env
# .env æ–‡ä»¶
OPENAI_API_KEY=sk-xxxxxxxxxxxxx
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4
```

### 2. å¯åŠ¨æœåŠ¡å™¨

```bash
python main.py
```

### 3. æµ‹è¯•å¯¹è¯

```bash
# æ–¹å¼1: è¿è¡Œæµ‹è¯•è„šæœ¬
python test_chat.py

# æ–¹å¼2: ä½¿ç”¨å‘½ä»¤è¡Œå®¢æˆ·ç«¯
python chat_client.py

# æ–¹å¼3: æ‰‹åŠ¨ curl æµ‹è¯•
curl -X POST "http://localhost:8000/api/v1/chat/sessions" \
  -H "Content-Type: application/json" \
  -d '{"knowledge_base_id": 1}'
```

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### âœ… ä¼šè¯ç®¡ç†
- å¤šä¼šè¯æ”¯æŒ
- çµæ´»é…ç½®ï¼ˆå‘é‡/å›¾è°±æœç´¢ï¼‰
- ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ¶ˆæ¯æ•°ã€Token æ•°ï¼‰

### âœ… RAG æ£€ç´¢å¢å¼º
- **å‘é‡æœç´¢**ï¼šåŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦
- **å›¾è°±æœç´¢**ï¼šåŸºäºå®ä½“å…³ç³»
- **æ··åˆæœç´¢**ï¼šç»“åˆä¸¤è€…ä¼˜åŠ¿

### âœ… æ»‘åŠ¨çª—å£ä¸Šä¸‹æ–‡
- è‡ªåŠ¨å¬å›å‰5æ¡å†å²æ¶ˆæ¯
- ä¿æŒå¯¹è¯è¿è´¯æ€§
- æ§åˆ¶ Token æ¶ˆè€—

### âœ… SSE æµå¼å“åº”
- å®æ—¶è¿”å›ç”Ÿæˆå†…å®¹
- æå‡ç”¨æˆ·ä½“éªŒ
- æ ‡å‡† SSE æ ¼å¼

### âœ… OpenAI é›†æˆ
- ä½¿ç”¨å®˜æ–¹ SDK
- æ”¯æŒè‡ªå®šä¹‰ API ç«¯ç‚¹
- çµæ´»çš„æ¨¡å‹é…ç½®

### âœ… è¯¦ç»†è®°å½•
- æ£€ç´¢åˆ°çš„æ–‡æ¡£å—
- æ£€ç´¢åˆ°çš„å®ä½“
- Token ç»Ÿè®¡
- å¤„ç†æ—¶é—´

## ğŸ“Š æ•°æ®æµç¤ºä¾‹

### è¯·æ±‚
```json
{
  "session_id": 1,
  "message": "å°æ˜çš„çˆ¶äº²æ˜¯è°ï¼Ÿ",
  "stream": true,
  "temperature": 0.7
}
```

### æµå¼å“åº”
```
data: {"type": "context", "data": {"chunks": 3, "entities": 2}}

data: {"type": "chunk", "data": "æ ¹æ®"}
data: {"type": "chunk", "data": "çŸ¥è¯†åº“"}
data: {"type": "chunk", "data": "çš„å†…å®¹"}
data: {"type": "chunk", "data": "ï¼Œå°æ˜çš„"}
data: {"type": "chunk", "data": "çˆ¶äº²æ˜¯"}
data: {"type": "chunk", "data": "å¼ ä¸‰ã€‚"}

data: {"type": "done", "data": {"message_id": 2, "processing_time": 1.234}}
```

### æ•°æ®åº“è®°å½•

**ç”¨æˆ·æ¶ˆæ¯**:
```json
{
  "id": 1,
  "session_id": 1,
  "role": "user",
  "content": "å°æ˜çš„çˆ¶äº²æ˜¯è°ï¼Ÿ",
  "token_count": 5
}
```

**åŠ©æ‰‹å›å¤**:
```json
{
  "id": 2,
  "session_id": 1,
  "role": "assistant",
  "content": "æ ¹æ®çŸ¥è¯†åº“çš„å†…å®¹ï¼Œå°æ˜çš„çˆ¶äº²æ˜¯å¼ ä¸‰ã€‚",
  "retrieved_chunks": [
    {
      "chunk_id": 123,
      "document_id": 45,
      "content": "å°æ˜çš„çˆ¶äº²æ˜¯å¼ ä¸‰...",
      "score": 0.92
    }
  ],
  "retrieved_entities": [
    {
      "entity_name": "å°æ˜",
      "entity_type": "Person",
      "related_entities": [
        {
          "name": "å¼ ä¸‰",
          "type": "Person",
          "relation": "çˆ¶äº²"
        }
      ]
    }
  ],
  "token_count": 15,
  "processing_time": 1.234
}
```

## ğŸ”§ é…ç½®é€‰é¡¹

### ä¼šè¯é…ç½®
| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `use_vector_search` | æ˜¯å¦ä½¿ç”¨å‘é‡æœç´¢ | true |
| `use_graph_search` | æ˜¯å¦ä½¿ç”¨å›¾è°±æœç´¢ | false |
| `search_top_k` | æ£€ç´¢æ–‡æ¡£æ•°é‡ | 5 |

### å¯¹è¯å‚æ•°
| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ | èŒƒå›´ |
|------|------|--------|------|
| `stream` | æ˜¯å¦æµå¼è¿”å› | true | - |
| `temperature` | ç”Ÿæˆæ¸©åº¦ | 0.7 | 0-2 |
| `max_tokens` | æœ€å¤§ç”Ÿæˆé•¿åº¦ | None | 1-4000 |

## ğŸ¨ å‰ç«¯é›†æˆ

### JavaScript ç¤ºä¾‹

```javascript
// æµå¼å¯¹è¯
const response = await fetch('/api/v1/chat/completions', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    session_id: 1,
    message: 'ä½ å¥½',
    stream: true
  })
});

const reader = response.body.getReader();
const decoder = new TextDecoder();

while (true) {
  const { done, value } = await reader.read();
  if (done) break;
  
  const text = decoder.decode(value);
  // å¤„ç† SSE æ•°æ®...
}
```

### Python ç¤ºä¾‹

```python
import requests
import json

# æµå¼å¯¹è¯
response = requests.post(
    'http://localhost:8000/api/v1/chat/completions',
    json={
        'session_id': 1,
        'message': 'ä½ å¥½',
        'stream': True
    },
    stream=True
)

for line in response.iter_lines():
    if line and line.startswith(b'data: '):
        data = json.loads(line[6:])
        if data['type'] == 'chunk':
            print(data['data'], end='', flush=True)
```

## ğŸ“ˆ æ€§èƒ½è€ƒè™‘

### ä¼˜åŒ–å»ºè®®

1. **æ§åˆ¶æ£€ç´¢æ•°é‡**
   - `search_top_k: 3` æ›´å¿«
   - `search_top_k: 10` æ›´å…¨é¢

2. **é€‰æ‹©æœç´¢ç­–ç•¥**
   - ä»…å‘é‡æœç´¢ï¼šæœ€å¿«
   - æ··åˆæœç´¢ï¼šæœ€å‡†ç¡®

3. **è°ƒæ•´ç”Ÿæˆå‚æ•°**
   - `temperature: 0.3` æ›´å‡†ç¡®
   - `temperature: 0.9` æ›´åˆ›é€ æ€§
   - `max_tokens: 500` é™åˆ¶é•¿åº¦

4. **ä½¿ç”¨åˆé€‚çš„æ¨¡å‹**
   - `gpt-3.5-turbo`: å¿«é€Ÿã€ç»æµ
   - `gpt-4`: å¼ºå¤§ã€æ˜‚è´µ

### æ€§èƒ½æŒ‡æ ‡

- **åˆ›å»ºä¼šè¯**: < 100ms
- **å‘é€æ¶ˆæ¯**: 1-5ç§’ï¼ˆå–å†³äºæ£€ç´¢å’Œç”Ÿæˆï¼‰
- **æ£€ç´¢æ–‡æ¡£**: < 500ms
- **ç”Ÿæˆå›å¤**: 1-3ç§’ï¼ˆæµå¼ï¼Œé¦– token å»¶è¿Ÿï¼‰

## ğŸ› æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **"æœªè®¾ç½® OPENAI_API_KEY"**
   - æ£€æŸ¥ `.env` æ–‡ä»¶
   - è¿è¡Œ `curl http://localhost:8000/config`

2. **"ä¼šè¯ X ä¸å­˜åœ¨"**
   - åˆ›å»ºæ–°ä¼šè¯
   - æ£€æŸ¥ä¼šè¯ ID æ˜¯å¦æ­£ç¡®

3. **æ£€ç´¢ä¸åˆ°æ–‡æ¡£**
   - ç¡®è®¤çŸ¥è¯†åº“æœ‰æ–‡æ¡£
   - ç¡®è®¤æ–‡æ¡£å·²å¤„ç†å®Œæˆ
   - ç¡®è®¤å‘é‡æœç´¢å·²å¯ç”¨

4. **SSE è¿æ¥ä¸­æ–­**
   - ä½¿ç”¨éæµå¼æ¨¡å¼
   - æ£€æŸ¥ä»£ç†æœåŠ¡å™¨é…ç½®

## ğŸ¯ æœªæ¥æ‰©å±•

### å¯èƒ½çš„æ”¹è¿›

1. **ç”¨æˆ·è®¤è¯**
   - ä¸ºæ¯ä¸ªç”¨æˆ·éš”ç¦»ä¼šè¯
   - æƒé™ç®¡ç†

2. **ä¼šè¯æ‘˜è¦**
   - è‡ªåŠ¨ç”Ÿæˆä¼šè¯æ ‡é¢˜
   - å®šæœŸç”Ÿæˆä¼šè¯æ‘˜è¦

3. **å¼•ç”¨æ ‡æ³¨**
   - åœ¨å›ç­”ä¸­æ ‡æ³¨å¼•ç”¨æ¥æº
   - ç‚¹å‡»è·³è½¬åˆ°åŸæ–‡æ¡£

4. **å¤šæ¨¡æ€æ”¯æŒ**
   - æ”¯æŒå›¾ç‰‡è¾“å…¥
   - æ”¯æŒæ–‡ä»¶ä¸Šä¼ 

5. **å¯¼å‡ºåŠŸèƒ½**
   - å¯¼å‡ºä¸º Markdown
   - å¯¼å‡ºä¸º PDF

6. **é«˜çº§æœç´¢**
   - æ—¶é—´èŒƒå›´ç­›é€‰
   - æ–‡æ¡£ç±»å‹ç­›é€‰
   - ç›¸å…³æ€§é˜ˆå€¼

7. **ç¼“å­˜ä¼˜åŒ–**
   - ç¼“å­˜æ£€ç´¢ç»“æœ
   - ç¼“å­˜ embeddings

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®Œæ•´ API æ–‡æ¡£](docs/CHAT_API_GUIDE.md)
- [å¿«é€Ÿå¯åŠ¨æŒ‡å—](docs/CHAT_QUICKSTART.md)
- [å›¾è°±æœç´¢æŒ‡å—](docs/GRAPH_SEARCH_GUIDE.md)
- [FastAPI æ–‡æ¡£](http://localhost:8000/docs)

## âœ… æ€»ç»“

### å®ç°çš„åŠŸèƒ½

âœ… å®Œæ•´çš„ä¼šè¯ç®¡ç†ç³»ç»Ÿ  
âœ… RAG æ£€ç´¢å¢å¼ºï¼ˆå‘é‡ + å›¾è°±ï¼‰  
âœ… æ»‘åŠ¨çª—å£ä¸Šä¸‹æ–‡ç®¡ç†  
âœ… SSE æµå¼å“åº”  
âœ… OpenAI é›†æˆ  
âœ… è¯¦ç»†çš„æ•°æ®è®°å½•å’Œç»Ÿè®¡  
âœ… å®Œæ•´çš„æ–‡æ¡£å’Œæµ‹è¯•å·¥å…·  

### ä»£ç è´¨é‡

âœ… æ¸…æ™°çš„ä»£ç ç»“æ„  
âœ… å®Œæ•´çš„ç±»å‹æ³¨è§£  
âœ… è¯¦ç»†çš„æ³¨é‡Šå’Œæ–‡æ¡£å­—ç¬¦ä¸²  
âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•  
âœ… éµå¾ª RESTful è®¾è®¡åŸåˆ™  

### ç”¨æˆ·ä½“éªŒ

âœ… å®æ—¶æµå¼å“åº”  
âœ… çµæ´»çš„é…ç½®é€‰é¡¹  
âœ… æ¸…æ™°çš„é”™è¯¯æç¤º  
âœ… å‘½ä»¤è¡Œå·¥å…·æ”¯æŒ  
âœ… è¯¦ç»†çš„ä½¿ç”¨æ–‡æ¡£  

**å¯¹è¯æ¥å£å®ç°å®Œæˆï¼ğŸ‰**

