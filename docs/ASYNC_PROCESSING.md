# å¼‚æ­¥æ–‡æ¡£å¤„ç†è¯´æ˜

## æ¦‚è¿°

RAG åç«¯ç³»ç»Ÿç°åœ¨æ”¯æŒå®Œå…¨å¼‚æ­¥çš„æ–‡æ¡£å¤„ç†ï¼ŒåŒ…æ‹¬ï¼š
- âœ… **éé˜»å¡è¿”å›**ï¼šåˆ›å»ºæ–‡æ¡£åç«‹å³è¿”å›æ–‡æ¡£ ID
- âœ… **åå°å¤„ç†**ï¼šæ–‡æ¡£åˆ†å—ã€å‘é‡åŒ–ã€å®ä½“å…³ç³»æå–åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œ
- âœ… **çŠ¶æ€ç›‘æ§**ï¼šå¯ä»¥éšæ—¶æŸ¥è¯¢æ–‡æ¡£å¤„ç†è¿›åº¦
- âœ… **å¤šä»»åŠ¡å¹¶å‘**ï¼šä½¿ç”¨çº¿ç¨‹æ± æ”¯æŒå¤šä¸ªæ–‡æ¡£åŒæ—¶å¤„ç†

## å¤„ç†æµç¨‹

```
åˆ›å»ºæ–‡æ¡£ â†’ ç«‹å³è¿”å› â†’ åå°å¤„ç†ï¼ˆåˆ†å— â†’ å‘é‡åŒ– â†’ NER â†’ çŸ¥è¯†å›¾è°±ï¼‰
   â†“
 è¿”å›æ–‡æ¡£ID
   â†“
è½®è¯¢çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
```

## æ ¸å¿ƒç‰¹æ€§

### 1. è‡ªåŠ¨åˆ†å—
æ ¹æ®çŸ¥è¯†åº“é…ç½®æˆ–ç”¨æˆ·æŒ‡å®šçš„ç­–ç•¥è¿›è¡Œæ–‡æ¡£åˆ†å—ï¼š
- **è¯­ä¹‰åˆ†å—**ï¼ˆsemanticï¼‰ï¼šæŒ‰å¥å­è¾¹ç•Œæ™ºèƒ½åˆ†å—
- **å›ºå®šå¤§å°åˆ†å—**ï¼ˆfixedï¼‰ï¼šå›ºå®šå­—ç¬¦æ•°åˆ†å—
- **é€’å½’åˆ†å—**ï¼ˆrecursiveï¼‰ï¼šé€’å½’æŒ‰æ®µè½ã€å¥å­åˆ†å—
- **æ®µè½åˆ†å—**ï¼ˆparagraphï¼‰ï¼šæŒ‰æ®µè½åˆ†å—

### 2. å‘é‡åŒ–å­˜å‚¨
- ä½¿ç”¨ FAISS è¿›è¡Œé«˜æ•ˆå‘é‡æ£€ç´¢
- é›†æˆ Ollama æœ¬åœ°æ¨¡å‹ç”ŸæˆåµŒå…¥å‘é‡
- æ”¯æŒå¤šç§ç´¢å¼•ç±»å‹å’Œè·ç¦»åº¦é‡

### 3. å®ä½“å…³ç³»æå–ï¼ˆå¯é€‰ï¼‰
- ä½¿ç”¨ LangGraph å·¥ä½œæµ
- é€šè¿‡ OpenAI API æå–å®ä½“å’Œå…³ç³»
- è‡ªåŠ¨è¯†åˆ«äººç‰©ã€åœ°ç‚¹ã€ç»„ç»‡ã€äº‹ä»¶ç­‰å®ä½“ç±»å‹

### 4. çŸ¥è¯†å›¾è°±å­˜å‚¨ï¼ˆå¯é€‰ï¼‰
- è‡ªåŠ¨å°†æå–çš„ä¸‰å…ƒç»„å­˜å‚¨åˆ° Neo4j
- æ”¯æŒå›¾è°±æŸ¥è¯¢å’Œå­å›¾æå–
- ä¸å‘é‡æ£€ç´¢äº’è¡¥ï¼Œæä¾›ç»“æ„åŒ–çŸ¥è¯†

## é…ç½®è¦æ±‚

### å¿…éœ€é…ç½®
```bash
# Ollama æœåŠ¡ï¼ˆç”¨äºå‘é‡åŒ–ï¼‰
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_EMBEDDING_MODEL=nomic-embed-text
```

### å¯é€‰é…ç½®ï¼ˆå¯ç”¨ NERï¼‰
```bash
# OpenAI API
OPENAI_API_KEY=your-api-key
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4
```

### å¯é€‰é…ç½®ï¼ˆå¯ç”¨çŸ¥è¯†å›¾è°±ï¼‰
```bash
# Neo4j æ•°æ®åº“
NEO4J_URI=bolt://localhost:7687
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=password
```

## API ä½¿ç”¨ç¤ºä¾‹

### 1. åˆ›å»ºçŸ¥è¯†åº“
```bash
POST /api/v1/knowledge-bases
{
  "name": "æˆ‘çš„çŸ¥è¯†åº“",
  "description": "æµ‹è¯•çŸ¥è¯†åº“",
  "enable_vector_store": true,    # å¯ç”¨å‘é‡å­˜å‚¨
  "enable_ner": true,              # å¯ç”¨å®ä½“å…³ç³»æå–
  "enable_knowledge_graph": true,  # å¯ç”¨çŸ¥è¯†å›¾è°±
  "default_chunk_strategy": "semantic",
  "embedding_model": "nomic-embed-text"
}
```

### 2. åˆ›å»ºæ–‡æ¡£ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
```bash
POST /api/v1/documents
{
  "knowledge_base_id": 1,
  "title": "æ–‡æ¡£æ ‡é¢˜",
  "content": "æ–‡æ¡£å†…å®¹...",
  "auto_process": true  # è‡ªåŠ¨å¼‚æ­¥å¤„ç†
}

# å“åº”ï¼ˆç«‹å³è¿”å›ï¼‰
{
  "id": 123,
  "title": "æ–‡æ¡£æ ‡é¢˜",
  "status": "pending",  # çŠ¶æ€ï¼špendingï¼ˆå¾…å¤„ç†ï¼‰
  "chunk_count": 0,
  ...
}
```

### 3. æŸ¥è¯¢å¤„ç†çŠ¶æ€
```bash
GET /api/v1/documents/123/status

# å“åº”
{
  "message": "æ–‡æ¡£çŠ¶æ€æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "document_id": 123,
    "db_status": "processing",      # pending/processing/completed/failed
    "in_processing_queue": true,    # æ˜¯å¦åœ¨å¤„ç†é˜Ÿåˆ—ä¸­
    "is_running": true,             # æ˜¯å¦æ­£åœ¨è¿è¡Œ
    "chunk_count": 5,               # å·²ç”Ÿæˆçš„åˆ†å—æ•°
    "vector_stored": false,         # æ˜¯å¦å·²å‘é‡åŒ–
    "graph_stored": false,          # æ˜¯å¦å·²å­˜å‚¨åˆ°å›¾è°±
    "processing_time": 12.5,        # å¤„ç†è€—æ—¶ï¼ˆç§’ï¼‰
    "error_message": null           # é”™è¯¯ä¿¡æ¯
  }
}
```

### 4. è·å–æ–‡æ¡£åˆ†å—
```bash
GET /api/v1/documents/123/chunks

# å“åº”
[
  {
    "id": 1,
    "content": "åˆ†å—å†…å®¹...",
    "chunk_index": 0,
    "has_embedding": true,
    "entities": ["å®ä½“1", "å®ä½“2"],
    "keywords": ["å…³é”®è¯1", "å…³é”®è¯2"]
  },
  ...
]
```

### 5. æœç´¢æ–‡æ¡£
```bash
POST /api/v1/search
{
  "query": "æœç´¢å…³é”®è¯",
  "knowledge_base_id": 1,
  "top_k": 5,
  "use_vector": true,
  "use_graph": false
}

# å“åº”
{
  "query": "æœç´¢å…³é”®è¯",
  "results": [
    {
      "chunk_id": 1,
      "document_id": 123,
      "document_title": "æ–‡æ¡£æ ‡é¢˜",
      "content": "ç›¸å…³å†…å®¹...",
      "score": 0.85,
      "chunk_index": 0
    },
    ...
  ],
  "total": 5,
  "processing_time": 0.123
}
```

## Python ç¤ºä¾‹ä»£ç 

```python
import requests
import time

BASE_URL = "http://localhost:8000"

# 1. åˆ›å»ºçŸ¥è¯†åº“
kb_response = requests.post(
    f"{BASE_URL}/api/v1/knowledge-bases",
    json={
        "name": "æµ‹è¯•çŸ¥è¯†åº“",
        "enable_vector_store": True,
        "enable_ner": True
    }
)
kb_id = kb_response.json()["id"]

# 2. åˆ›å»ºæ–‡æ¡£ï¼ˆç«‹å³è¿”å›ï¼‰
doc_response = requests.post(
    f"{BASE_URL}/api/v1/documents",
    json={
        "knowledge_base_id": kb_id,
        "title": "æµ‹è¯•æ–‡æ¡£",
        "content": "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡æ¡£...",
        "auto_process": True
    }
)
doc_id = doc_response.json()["id"]
print(f"æ–‡æ¡£å·²åˆ›å»º: {doc_id}")

# 3. è½®è¯¢çŠ¶æ€ç›´åˆ°å®Œæˆ
while True:
    status_response = requests.get(
        f"{BASE_URL}/api/v1/documents/{doc_id}/status"
    )
    status = status_response.json()["data"]["db_status"]
    
    print(f"å½“å‰çŠ¶æ€: {status}")
    
    if status in ["completed", "failed"]:
        break
    
    time.sleep(2)

# 4. æœç´¢æ–‡æ¡£
search_response = requests.post(
    f"{BASE_URL}/api/v1/search",
    json={
        "query": "æµ‹è¯•",
        "knowledge_base_id": kb_id,
        "top_k": 5
    }
)
results = search_response.json()["results"]
print(f"æ‰¾åˆ° {len(results)} ä¸ªç»“æœ")
```

## æµ‹è¯•è„šæœ¬

è¿è¡Œå®Œæ•´çš„å¼‚æ­¥å¤„ç†æµ‹è¯•ï¼š

```bash
# å¯åŠ¨æœåŠ¡å™¨
python main.py

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œæµ‹è¯•
python test_async_processing.py
```

æµ‹è¯•è„šæœ¬ä¼šï¼š
1. åˆ›å»ºçŸ¥è¯†åº“
2. åˆ›å»ºæ–‡æ¡£ï¼ˆç«‹å³è¿”å›ï¼‰
3. ç›‘æ§å¤„ç†è¿›åº¦
4. æŸ¥çœ‹åˆ†å—ç»“æœ
5. æ‰§è¡Œæœç´¢æµ‹è¯•

## æ€§èƒ½è¯´æ˜

### éé˜»å¡å“åº”æ—¶é—´
- **åˆ›å»ºæ–‡æ¡£è¯·æ±‚**ï¼š< 100msï¼ˆç«‹å³è¿”å›ï¼‰
- **çŠ¶æ€æŸ¥è¯¢è¯·æ±‚**ï¼š< 50ms

### åå°å¤„ç†æ—¶é—´ï¼ˆå–å†³äºæ–‡æ¡£å¤§å°å’Œé…ç½®ï¼‰
- **ä»…åˆ†å—**ï¼š0.5 - 2ç§’
- **åˆ†å— + å‘é‡åŒ–**ï¼š2 - 10ç§’
- **åˆ†å— + å‘é‡åŒ– + NER**ï¼š10 - 60ç§’ï¼ˆå–å†³äº API å“åº”æ—¶é—´ï¼‰
- **å®Œæ•´æµç¨‹**ï¼ˆå«çŸ¥è¯†å›¾è°±ï¼‰ï¼š15 - 90ç§’

### å¹¶å‘èƒ½åŠ›
- é»˜è®¤çº¿ç¨‹æ± å¤§å°ï¼š4 ä¸ªå·¥ä½œçº¿ç¨‹
- å¯åŒæ—¶å¤„ç† 4 ä¸ªæ–‡æ¡£
- æ›´å¤šæ–‡æ¡£ä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…

## é”™è¯¯å¤„ç†

ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†å„ç§é”™è¯¯æƒ…å†µï¼š
- âœ… åˆ†å—å¤±è´¥ â†’ æ ‡è®°ä¸º FAILED çŠ¶æ€
- âœ… å‘é‡åŒ–å¤±è´¥ â†’ è®°å½•è­¦å‘Šï¼Œç»§ç»­å…¶ä»–æ­¥éª¤
- âœ… NER å¤±è´¥ â†’ è®°å½•è­¦å‘Šï¼Œç»§ç»­å…¶ä»–æ­¥éª¤
- âœ… çŸ¥è¯†å›¾è°±å¤±è´¥ â†’ è®°å½•è­¦å‘Šï¼Œå®Œæˆå…¶ä»–æ­¥éª¤

æ‰€æœ‰é”™è¯¯ä¿¡æ¯éƒ½ä¼šè®°å½•åœ¨æ–‡æ¡£çš„ `error_message` å­—æ®µä¸­ã€‚

## ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹å¤„ç†æ—¥å¿—
æœåŠ¡å™¨æ—¥å¿—ä¼šå®æ—¶æ˜¾ç¤ºå¤„ç†è¿›åº¦ï¼š
```
ğŸš€ å¼€å§‹å¤„ç†æ–‡æ¡£ 123
[æ­¥éª¤ 1/4] æ–‡æ¡£åˆ†å—...
âœ… ç”Ÿæˆ 5 ä¸ªåˆ†å—
[æ­¥éª¤ 2/4] å‘é‡åŒ–...
âœ… å‘é‡åŒ–å®Œæˆ
[æ­¥éª¤ 3/4] å®ä½“å…³ç³»æå–...
âœ… æå–äº† 15 ä¸ªå®ä½“ï¼Œ8 ä¸ªå…³ç³»
[æ­¥éª¤ 4/4] çŸ¥è¯†å›¾è°±å­˜å‚¨...
âœ… çŸ¥è¯†å›¾è°±å­˜å‚¨å®Œæˆ
âœ… æ–‡æ¡£ 123 å¤„ç†å®Œæˆï¼ˆè€—æ—¶: 25.3ç§’ï¼‰
```

### é˜Ÿåˆ—çŠ¶æ€
ä½¿ç”¨çŠ¶æ€ API æŸ¥è¯¢æ–‡æ¡£æ˜¯å¦åœ¨å¤„ç†é˜Ÿåˆ—ä¸­ï¼š
- `in_processing_queue: true` - åœ¨é˜Ÿåˆ—ä¸­
- `is_running: true` - æ­£åœ¨å¤„ç†
- `is_running: false` - é˜Ÿåˆ—ä¸­ç­‰å¾…

## æœ€ä½³å®è·µ

1. **å¯ç”¨åˆé€‚çš„åŠŸèƒ½**
   - å°è§„æ¨¡åº”ç”¨ï¼šåªå¯ç”¨å‘é‡å­˜å‚¨
   - ä¸­ç­‰è§„æ¨¡ï¼šå‘é‡å­˜å‚¨ + NER
   - å¤§è§„æ¨¡/å¤æ‚æŸ¥è¯¢ï¼šå…¨éƒ¨å¯ç”¨

2. **è°ƒæ•´çº¿ç¨‹æ± å¤§å°**
   - æ ¹æ®æœåŠ¡å™¨æ€§èƒ½è°ƒæ•´ `MAX_PROCESSING_WORKERS`
   - CPU å¯†é›†å‹ï¼šworkers = CPU æ ¸å¿ƒæ•°
   - IO å¯†é›†å‹ï¼šworkers = CPU æ ¸å¿ƒæ•° * 2-4

3. **ç›‘æ§å¤„ç†è¿›åº¦**
   - å®šæœŸè½®è¯¢çŠ¶æ€ API
   - è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
   - å¤„ç†å¤±è´¥æƒ…å†µ

4. **æ‰¹é‡æ“ä½œ**
   - ä¸€æ¬¡åˆ›å»ºå¤šä¸ªæ–‡æ¡£
   - è®©ç³»ç»Ÿè‡ªåŠ¨æ’é˜Ÿå¤„ç†
   - å‡å°‘ç­‰å¾…æ—¶é—´

## æ•…éšœæ’æŸ¥

### æ–‡æ¡£ä¸€ç›´å¤„äº PROCESSING çŠ¶æ€
- æ£€æŸ¥åå°çº¿ç¨‹æ˜¯å¦å´©æºƒ
- æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
- é‡å¯æœåŠ¡å™¨

### å‘é‡åŒ–å¤±è´¥
- ç¡®ä¿ Ollama æœåŠ¡æ­£åœ¨è¿è¡Œ
- æ£€æŸ¥ `OLLAMA_BASE_URL` é…ç½®
- éªŒè¯æ¨¡å‹æ˜¯å¦å·²ä¸‹è½½

### NER å¤±è´¥
- æ£€æŸ¥ `OPENAI_API_KEY` æ˜¯å¦è®¾ç½®
- éªŒè¯ API é…é¢æ˜¯å¦å……è¶³
- æ£€æŸ¥ç½‘ç»œè¿æ¥

### çŸ¥è¯†å›¾è°±å¤±è´¥
- ç¡®ä¿ Neo4j æ­£åœ¨è¿è¡Œ
- æ£€æŸ¥è¿æ¥é…ç½®
- éªŒè¯æ•°æ®åº“æƒé™

## ç›¸å…³æ–‡æ¡£

- [API å®Œæ•´æ–‡æ¡£](API_DOCUMENTATION.md)
- [é¡¹ç›® README](README.md)
- [ç¯å¢ƒå˜é‡é…ç½®](config.example.env)

